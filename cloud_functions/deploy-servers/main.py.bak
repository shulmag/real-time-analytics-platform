'''
Author: Developer Ray
Date: 2025-03-19
Last Editor: Developer Ray
Last Edit Date: 2025-03-24
Description: Deploy all servers using a bash script and Python script. Creating a cloud function allows us to periodically 
             deploy servers so it kills all the current instances and helps with Google Cloud memory leaks due to re-using instances 
             during periods of high volume or when there is a warm instance active. Deploying new services does not kill 
             the requests currently being served; Google Cloud waits for these to be complete before killing all of the 
             instances that were serving the requests before the new deployments are complete. There are two parts: 
             (1) build images and (2) deploy all servers with traffic updates post-deployment. This was originally 
             a bash script, named `_deploy-ficc-servers.sh`, which is now deprecated. The decision to convert 
             to a Python script instead of keeping it as a bash script is because `gcloud ...` commands were 
             not available for a Google Cloud function, and so this script could not be run with a Google 
             Cloud scheduler job. Heavily generated by ChatGPT from the bash script.
'''
import functions_framework


# # uncomment the below when running locally
# import os
# os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = '/Users/user/ficc/ficc/mitas_creds.json'


from build_image import build_all_images
from deploy_and_update_traffic import deploy_all_services


def main(build_images: bool, deploy_services: bool):
    '''`build_images` is a Boolean which controls whether we build images or not. `deploy_services` 
    is a Boolean which controls whether we deploy services or not.'''
    if build_images: build_all_images()
    if deploy_services: deploy_all_services(ignore_infrequently_used_services=not build_images)    # if not building images, then this code is just to re-deploy services to reduce memory issues and so infrequently used services do not need to be re-deployed


@functions_framework.http
def run_script(request):
    main(build_images=False, deploy_services=True)    # do not need to build images each time since this cloud function is just for re-deploying the services to clear memory leaks
    return 'SUCCESS'
