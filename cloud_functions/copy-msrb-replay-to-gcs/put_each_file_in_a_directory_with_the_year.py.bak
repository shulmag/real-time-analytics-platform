'''
Author: Developer Ray
Create Date: 2025-01-02
Last Editor: Developer Ray
Last Edit Date: 2025-01-02
Description: Put each file that is not in a directory into a directory where the directory name is the year of the 
             date for which the file is the replay. Heavily generated by ChatGPT.

             **NOTE**: To see the output of this script in an `output.txt` file use the command: $ python -u put_each_file_in_a_directory_with_the_year.py >> output.txt. 
             **NOTE**: To run the procedure in the background, use the command: $ nohup python -u put_each_file_in_a_directory_with_the_year.py >> output.txt 2>&1 &. This will return a process number such as [1] 66581, which can be used to kill the process.
             Breakdown:
             1. `nohup`: This allows the script to continue running even after you log out or close the terminal.
             2. python -u <file_name>.py: This part is executing your Python script in unbuffered mode (meaning that output is written immediately). If you are using Python 3, you might want to specify python3 instead of just python, depending on your environment.
             3. >> output.txt 2>&1:
                 * >> output.txt appends the standard output (stdout) of the script to output.txt instead of overwriting it.
                 * 2>&1 redirects standard error (stderr) to the same file as standard output, so both stdout and stderr go into output.txt.
             4. &: This runs the command in the background.
'''
import os

from google.cloud import storage


os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = '/Users/user/ficc/ficc/mitas_creds.json'

STORAGE_CLIENT = storage.Client()

MSRB_DAILY_REPLAY_FILE_BUCKET_NAME = 'msrb_trade_history'
FILENAME_PREFIX = 'daily_replay_file_'


def can_be_converted_to_int(year: str) -> bool:
    try:
        int(year)
        return True
    except Exception:
        return False


def move_files_to_year_folder(bucket_name: str, prefix: str) -> None:
    bucket = STORAGE_CLIENT.bucket(bucket_name)
    blobs = bucket.list_blobs()    # list all files in the bucket
    blobs_not_in_folder = [blob for blob in blobs if '/' not in blob.name]    # check if the file is already in a folder (i.e., has a '/' in the name)
    prefix_len = len(prefix)
    for blob in blobs_not_in_folder:
        original_filename = blob.name
        filename_prefix = original_filename[:prefix_len]
        if filename_prefix != prefix:
            print(f'{original_filename} does not have the prefix: {prefix}')
            continue
        
        year = original_filename[prefix_len : prefix_len + 4]    # 4 comes from the number of characters in YYYY
        assert can_be_converted_to_int(year), f'{year} is supposed to represent a year but cannot be converted to an integer'
        new_filename = f'{year}/{original_filename}'    # file name with folder
        bucket.copy_blob(blob, bucket, new_filename)    # copy the file to the new path
        blob.delete()    # delete the original file
        print(f'Moved {original_filename} to {new_filename}')


if __name__ == '__main__':
    move_files_to_year_folder(MSRB_DAILY_REPLAY_FILE_BUCKET_NAME, FILENAME_PREFIX)
