'''
Author: Developer Ray
Create Date: 2025-01-03
Last Editor: Developer Ray
Last Edit Date: 2025-01-03
Description: Remove timestamp from each file. Heavily generated by ChatGPT.

             **NOTE**: To see the output of this script in an `output.txt` file use the command: $ python -u remove_timestamp_from_each_filename.py >> output.txt. 
             **NOTE**: To run the procedure in the background, use the command: $ nohup python -u remove_timestamp_from_each_filename.py >> output.txt 2>&1 &. This will return a process number such as [1] 66581, which can be used to kill the process.
             Breakdown:
             1. `nohup`: This allows the script to continue running even after you log out or close the terminal.
             2. python -u <file_name>.py: This part is executing your Python script in unbuffered mode (meaning that output is written immediately). If you are using Python 3, you might want to specify python3 instead of just python, depending on your environment.
             3. >> output.txt 2>&1:
                 * >> output.txt appends the standard output (stdout) of the script to output.txt instead of overwriting it.
                 * 2>&1 redirects standard error (stderr) to the same file as standard output, so both stdout and stderr go into output.txt.
             4. &: This runs the command in the background.
'''
import os

from google.cloud import storage


os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = '/Users/user/ficc/ficc/mitas_creds.json'

STORAGE_CLIENT = storage.Client()

MSRB_DAILY_REPLAY_FILE_BUCKET_NAME = 'msrb_trade_history'
TIMESTAMP_SUFFIX = ' 00:00:00'
FILENAME_EXTENSION = '.txt'


def remove_timestamp_from_each_filename(bucket_name: str, suffix: str, extension: str) -> None:
    '''Assumes that `suffix` is the last part of the filename before the `extension`.'''
    bucket = STORAGE_CLIENT.bucket(bucket_name)
    blobs = bucket.list_blobs()    # list all files in the bucket
    ending = suffix + extension
    blobs_with_ending = [blob for blob in blobs if blob.name.endswith(ending)]
    for blob in blobs_with_ending:
        original_filename = blob.name
        original_filename_without_ending = original_filename[:-len(ending)]
        new_filename = f'{original_filename_without_ending}{extension}'    # file name without ending but with extension
        bucket.copy_blob(blob, bucket, new_filename)    # copy the file to the new path
        blob.delete()    # delete the original file
        print(f'Moved {original_filename} to {new_filename}')


if __name__ == '__main__':
    remove_timestamp_from_each_filename(MSRB_DAILY_REPLAY_FILE_BUCKET_NAME, TIMESTAMP_SUFFIX, FILENAME_EXTENSION)
