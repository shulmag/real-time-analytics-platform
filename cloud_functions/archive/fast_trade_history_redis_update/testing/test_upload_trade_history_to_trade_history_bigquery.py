'''
'''
import os
from functools import wraps
import time
from datetime import timedelta

import pandas as pd

from google.cloud import bigquery


pd.options.mode.chained_assignment = None    # default='warn'; suppresses `SettingWithCopyWarning` in Pandas

TESTING = True
TESTING_FILENAME_ADDENDUM = '_from_fast_redis_update'

# TODO: comment the below line out when not running the function locally
os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = '/Users/user/ficc/ficc/mitas_creds.json'    # filepath for creds file on local machine

PROJECT_ID = 'eng-reactor-287421'
LOCATION = 'US'

FEATURES_FOR_EACH_TRADE_IN_HISTORY = {'msrb_valid_from_date': 'DATETIME', 
                                      'msrb_valid_to_date': 'DATETIME', 
                                      'rtrs_control_number': 'INTEGER', 
                                      'trade_datetime': 'DATETIME', 
                                      'publish_datetime': 'DATETIME', 
                                      'yield': 'FLOAT', 
                                      'dollar_price': 'FLOAT', 
                                      'par_traded': 'NUMERIC', 
                                      'trade_type': 'STRING', 
                                      'is_non_transaction_based_compensation': 'BOOLEAN', 
                                      'is_lop_or_takedown': 'BOOLEAN', 
                                      'brokers_broker': 'STRING', 
                                      'is_alternative_trading_system': 'BOOLEAN', 
                                      'is_weighted_average_price': 'BOOLEAN', 
                                      'settlement_date': 'DATE', 
                                      'calc_date': 'DATE', 
                                      'calc_day_cat': 'INTEGER', 
                                      'maturity_date': 'DATE', 
                                      'next_call_date': 'DATE', 
                                      'par_call_date': 'DATE', 
                                      'refund_date': 'DATE', 
                                      'transaction_type': 'STRING', 
                                      'sequence_number': 'INTEGER'}


def function_timer(function_to_time):
    '''This function is to be used as a decorator. It will print out the execution time of `function_to_time`.'''
    @wraps(function_to_time)    # used to ensure that the function name is still the same after applying the decorator when running tests: https://stackoverflow.com/questions/6312167/python-unittest-cant-call-decorated-test
    def wrapper(*args, **kwargs):    # using the same formatting from https://docs.python.org/3/library/functools.html
        print(f'BEGIN {function_to_time.__name__}')
        start_time = time.time()
        result = function_to_time(*args, **kwargs)
        end_time = time.time()
        print(f'END {function_to_time.__name__}. Execution time: {timedelta(seconds=end_time - start_time)}')
        return result
    return wrapper


def upload_to_bigquery(table_name, schema, df_or_dict, function_name=None):
    '''Uploads `df_or_dict` (after converting the object to a dictionary if it is passed in as a pandas DataFrame) to 
    `table_name` (with `schema`) using the function `load_table_from_json(...)`. If `function_name` is not `None`, then 
    we wait until the job is completed and print the job status (success or failure).'''
    # if isinstance(df_or_dict, pd.DataFrame): df_or_dict = df_to_json_dict(df_or_dict)
    client = bigquery.Client(project=PROJECT_ID, location=LOCATION)
    job_config = bigquery.LoadJobConfig(schema=schema, write_disposition='WRITE_APPEND')
    table_name = f'{PROJECT_ID}.{table_name}'
    if TESTING: table_name = table_name + TESTING_FILENAME_ADDENDUM    # NOTE: table will be automatically created the first time that this function is run
    job = client.load_table_from_json(df_or_dict, table_name, job_config=job_config)
    if function_name is not None:
        try:    # removing this try...catch would make `client.load_table_from_dataframe(...)` asynchronous since `job.result()` would be removed
            job.result()    # waits for job to complete
            print(f'Upload Successful in `{function_name}`')
        except Exception as e:
            print(f'Upload Failed in `{function_name}`')
            print('Dataframe')
            num_rows_to_print_at_once = 50    # if the dataframe is too large, then it gets truncated in the logs, so we print chunks of it so that it can all be viewed; 50 is chosen since the last time this happened, we were able to see 84 rows in the logs before truncation
            for start_idx in range(0, len(df_or_dict), num_rows_to_print_at_once):
                end_idx = min(start_idx + num_rows_to_print_at_once, len(df_or_dict))
                print(f'Rows {start_idx} to {end_idx}')
                print(df_or_dict[start_idx : end_idx])
            print('Schema')
            print(schema)
            raise e


@function_timer
def upload_trade_history_to_trade_history_bigquery(df_list):
    schema = [bigquery.SchemaField('cusip', 'STRING'), 
              bigquery.SchemaField('recent', 'RECORD', mode='REPEATED', fields=[bigquery.SchemaField(feature, schema_type) for feature, schema_type in FEATURES_FOR_EACH_TRADE_IN_HISTORY.items()])]    # `recent` corresponds to trade history
    upload_to_bigquery('demo_monitoring.trade_history_only', schema, df_list, 'upload_trade_history_to_trade_history_bigquery')    # TODO: remove final argument for procedure to be asynchronous


df_list = [{'cusip': '097428FB7', 'recent': [{'msrb_valid_from_date': '2023-08-09T17:07:08', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080912569100, 'trade_datetime': '2023-08-09T17:06:04', 'publish_datetime': '2023-08-09T17:07:08', 'yield': 4.141, 'dollar_price': 97.92, 'par_traded': 10000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-11', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 55289}, {'msrb_valid_from_date': '2023-08-09T16:51:51', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080912379000, 'trade_datetime': '2023-08-09T16:50:27', 'publish_datetime': '2023-08-09T16:51:51', 'yield': 4.141, 'dollar_price': 97.92, 'par_traded': 45000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-11', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 54811}, {'msrb_valid_from_date': '2023-08-09T16:38:36', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080912142400, 'trade_datetime': '2023-08-09T16:36:16', 'publish_datetime': '2023-08-09T16:38:36', 'yield': 4.141, 'dollar_price': 97.92, 'par_traded': 25000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-11', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 54239}, {'msrb_valid_from_date': '2023-08-09T16:25:40', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080911796700, 'trade_datetime': '2023-08-09T16:24:45', 'publish_datetime': '2023-08-09T16:25:40', 'yield': 4.141, 'dollar_price': 97.92, 'par_traded': 50000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-11', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 53173}, {'msrb_valid_from_date': '2023-08-09T16:25:40', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080911796600, 'trade_datetime': '2023-08-09T16:24:28', 'publish_datetime': '2023-08-09T16:25:40', 'yield': 4.141, 'dollar_price': 97.92, 'par_traded': 25000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-11', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 53172}, {'msrb_valid_from_date': '2023-08-09T16:19:46', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080911670800, 'trade_datetime': '2023-08-09T16:17:14', 'publish_datetime': '2023-08-09T16:19:46', 'yield': 4.28, 'dollar_price': 95.92, 'par_traded': 200000, 'trade_type': 'D', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': True, 'is_weighted_average_price': False, 'settlement_date': '2023-08-11', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 52759}, {'msrb_valid_from_date': '2023-08-09T16:17:46', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080911670700, 'trade_datetime': '2023-08-09T16:17:14', 'publish_datetime': '2023-08-09T16:17:46', 'yield': 4.284, 'dollar_price': 95.86, 'par_traded': 200000, 'trade_type': 'P', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-11', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 52581}, {'msrb_valid_from_date': '2023-08-09T15:57:18', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080911049600, 'trade_datetime': '2023-08-09T15:53:46', 'publish_datetime': '2023-08-09T15:57:18', 'yield': 4.28, 'dollar_price': 95.92, 'par_traded': 50000, 'trade_type': 'D', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': True, 'is_weighted_average_price': False, 'settlement_date': '2023-08-11', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 50167}, {'msrb_valid_from_date': '2023-08-09T15:54:37', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080911049400, 'trade_datetime': '2023-08-09T15:53:46', 'publish_datetime': '2023-08-09T15:54:37', 'yield': 4.289, 'dollar_price': 95.795, 'par_traded': 50000, 'trade_type': 'P', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-11', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 49912}, {'msrb_valid_from_date': '2023-08-01T12:08:43', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080105363500, 'trade_datetime': '2023-08-01T12:08:37', 'publish_datetime': '2023-08-01T12:08:43', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 35000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-03', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 22583.0}, {'msrb_valid_from_date': '2023-08-01T11:56:18', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080104900400, 'trade_datetime': '2023-08-01T11:56:03', 'publish_datetime': '2023-08-01T11:56:18', 'yield': 4.256, 'dollar_price': 96.257, 'par_traded': 50000, 'trade_type': 'S', 'is_non_transaction_based_compensation': True, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-03', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 20597.0}, {'msrb_valid_from_date': '2023-08-01T10:50:47', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080102742400, 'trade_datetime': '2023-08-01T10:50:38', 'publish_datetime': '2023-08-01T10:50:47', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 15000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-03', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 11438.0}, {'msrb_valid_from_date': '2023-08-01T10:45:46', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080102597200, 'trade_datetime': '2023-08-01T10:45:37', 'publish_datetime': '2023-08-01T10:45:46', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 10000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-03', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 10874.0}, {'msrb_valid_from_date': '2023-08-01T08:12:15', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080100137700, 'trade_datetime': '2023-08-01T08:12:11', 'publish_datetime': '2023-08-01T08:12:15', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 25000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-03', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 842.0}, {'msrb_valid_from_date': '2023-08-01T08:12:10', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080100137500, 'trade_datetime': '2023-08-01T08:12:06', 'publish_datetime': '2023-08-01T08:12:10', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 20000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-03', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 841.0}, {'msrb_valid_from_date': '2023-08-01T08:12:03', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023080100136700, 'trade_datetime': '2023-08-01T08:11:58', 'publish_datetime': '2023-08-01T08:12:03', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 10000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-03', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 838.0}, {'msrb_valid_from_date': '2023-07-31T16:31:36', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073110063100, 'trade_datetime': '2023-07-31T16:31:28', 'publish_datetime': '2023-07-31T16:31:36', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 20000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 42847.0}, {'msrb_valid_from_date': '2023-07-31T15:02:35', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073108424600, 'trade_datetime': '2023-07-31T15:02:24', 'publish_datetime': '2023-07-31T15:02:35', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 30000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 36031.0}, {'msrb_valid_from_date': '2023-07-31T15:01:58', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073108413000, 'trade_datetime': '2023-07-31T15:01:13', 'publish_datetime': '2023-07-31T15:01:58', 'yield': 4.256, 'dollar_price': 96.257, 'par_traded': 215000, 'trade_type': 'D', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': True, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 35991.0}, {'msrb_valid_from_date': '2023-07-31T15:01:58', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073108412500, 'trade_datetime': '2023-07-31T15:01:13', 'publish_datetime': '2023-07-31T15:01:58', 'yield': 4.26, 'dollar_price': 96.197, 'par_traded': 215000, 'trade_type': 'P', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 35978.0}, {'msrb_valid_from_date': '2023-07-31T13:56:50', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073106808400, 'trade_datetime': '2023-07-31T13:56:12', 'publish_datetime': '2023-07-31T13:56:50', 'yield': 4.256, 'dollar_price': 96.257, 'par_traded': 10000, 'trade_type': 'D', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': True, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 29120.0}, {'msrb_valid_from_date': '2023-07-31T13:56:50', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073106808300, 'trade_datetime': '2023-07-31T13:56:12', 'publish_datetime': '2023-07-31T13:56:50', 'yield': 4.274, 'dollar_price': 96.007, 'par_traded': 10000, 'trade_type': 'P', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 29119.0}, {'msrb_valid_from_date': '2023-07-31T13:56:21', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073106800700, 'trade_datetime': '2023-07-31T13:56:12', 'publish_datetime': '2023-07-31T13:56:21', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 10000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 29089.0}, {'msrb_valid_from_date': '2023-07-31T13:49:16', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073106630900, 'trade_datetime': '2023-07-31T13:48:31', 'publish_datetime': '2023-07-31T13:49:16', 'yield': 4.256, 'dollar_price': 96.257, 'par_traded': 10000, 'trade_type': 'D', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': True, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 28369.0}, {'msrb_valid_from_date': '2023-07-31T13:49:15', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073106630800, 'trade_datetime': '2023-07-31T13:48:31', 'publish_datetime': '2023-07-31T13:49:15', 'yield': 4.274, 'dollar_price': 96.007, 'par_traded': 10000, 'trade_type': 'P', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 28368.0}, {'msrb_valid_from_date': '2023-07-31T13:48:39', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023073106621400, 'trade_datetime': '2023-07-31T13:48:31', 'publish_datetime': '2023-07-31T13:48:39', 'yield': 4.123, 'dollar_price': 98.182, 'par_traded': 10000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-08-02', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 28329.0}, {'msrb_valid_from_date': '2023-07-24T11:42:42', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023072403027400, 'trade_datetime': '2023-07-24T11:42:18', 'publish_datetime': '2023-07-24T11:42:42', 'yield': 4.198, 'dollar_price': 97.088, 'par_traded': 10000, 'trade_type': 'D', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': True, 'is_weighted_average_price': False, 'settlement_date': '2023-07-26', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 13190.0}, {'msrb_valid_from_date': '2023-07-24T11:42:27', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023072403023700, 'trade_datetime': '2023-07-24T11:42:18', 'publish_datetime': '2023-07-24T11:42:27', 'yield': 4.191, 'dollar_price': 97.188, 'par_traded': 10000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-07-26', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 13174.0}, {'msrb_valid_from_date': '2023-07-24T11:42:58', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023072403038900, 'trade_datetime': '2023-07-24T11:42:15', 'publish_datetime': '2023-07-24T11:42:58', 'yield': 4.274, 'dollar_price': 96.005, 'par_traded': 10000, 'trade_type': 'P', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2023-07-26', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 13274.0}, {'msrb_valid_from_date': '2023-07-24T11:42:58', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2023072403038600, 'trade_datetime': '2023-07-24T11:42:15', 'publish_datetime': '2023-07-24T11:42:58', 'yield': 4.256, 'dollar_price': 96.255, 'par_traded': 10000, 'trade_type': 'D', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': False, 'brokers_broker': None, 'is_alternative_trading_system': True, 'is_weighted_average_price': False, 'settlement_date': '2023-07-26', 'calc_date': '2046-09-01', 'calc_day_cat': 2, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 13273.0}, {'msrb_valid_from_date': '2021-08-04T13:32:53', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2021080404079800, 'trade_datetime': '2021-08-04T13:30:00', 'publish_datetime': '2021-08-04T13:32:53', 'yield': 1.99, 'dollar_price': 118.207, 'par_traded': 2205000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': True, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2021-08-17', 'calc_date': '2031-09-01', 'calc_day_cat': 0, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 18784.0}, {'msrb_valid_from_date': '2021-08-04T13:32:53', 'msrb_valid_to_date': '2100-01-01T00:00:00', 'rtrs_control_number': 2021080404077800, 'trade_datetime': '2021-08-04T13:30:00', 'publish_datetime': '2021-08-04T13:32:53', 'yield': 1.99, 'dollar_price': 118.207, 'par_traded': 2150000, 'trade_type': 'S', 'is_non_transaction_based_compensation': False, 'is_lop_or_takedown': True, 'brokers_broker': None, 'is_alternative_trading_system': False, 'is_weighted_average_price': False, 'settlement_date': '2021-08-17', 'calc_date': '2031-09-01', 'calc_day_cat': 0, 'maturity_date': '2046-09-01', 'next_call_date': '2031-09-01', 'par_call_date': '2031-09-01', 'refund_date': None, 'transaction_type': 'I', 'sequence_number': 18764.0}]}]
cusip_and_history = df_list[0]
cusip, history = cusip_and_history['cusip'], cusip_and_history['recent']
df_list_where_recent_is_a_single_trade_in_history = [{'cusip': cusip, 'recent': [history[idx]]} for idx in range(len(history))]
# for trade_history_idx in range(len(history)):
#     print(trade_history_idx)
#     upload_trade_history_to_trade_history_bigquery([df_list_where_recent_is_a_single_trade_in_history[trade_history_idx]])
print(df_list_where_recent_is_a_single_trade_in_history[0])
print(df_list_where_recent_is_a_single_trade_in_history[9])
# upload_trade_history_to_trade_history_bigquery(df_list)
