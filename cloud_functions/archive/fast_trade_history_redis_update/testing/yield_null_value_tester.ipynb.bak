{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "'''\n",
    "Author: Developer Ray\n",
    "Date: 2023-08-18\n",
    "Last Editor: Developer Ray\n",
    "Last Edit Date: 2023-08-18\n",
    "Description: Dtermine how null yields are handled in `cloud_functions/fast_trade_history_redis_update/main.py`.\n",
    "'''"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "%load_ext autoreload\n",
    "%autoreload 2\n",
    "\n",
    "import os\n",
    "import pandas as pd\n",
    "\n",
    "\n",
    "os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = './mitas_creds.json'\n",
    "\n",
    "\n",
    "from main import typecast_yield, add_calc_date"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [],
   "source": [
    "data = pd.read_csv('testing/8-18_test_cusip_2.csv')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "str"
      ]
     },
     "execution_count": 22,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "type(data['settlement_date'].iloc[0])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "metadata": {},
   "outputs": [],
   "source": [
    "data['yield'] = None\n",
    "data['par_call_date'] = pd.to_datetime(data['par_call_date'].iloc[0]).date()\n",
    "data['settlement_date'] = pd.to_datetime(data['settlement_date'].iloc[0]).date()\n",
    "data['previous_coupon_payment_date'] = pd.to_datetime(data['previous_coupon_payment_date'].iloc[0]).date()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'datetime.date'>\n",
      "<class 'datetime.date'>\n",
      "<class 'pandas._libs.tslibs.nattype.NaTType'>\n"
     ]
    }
   ],
   "source": [
    "print(type(data['par_call_date'].iloc[0]))\n",
    "print(type(data['settlement_date'].iloc[0]))\n",
    "print(type(data['previous_coupon_payment_date'].iloc[0]))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "0    None\n",
      "Name: yield, dtype: object\n",
      "yield after converting to float\n",
      "0   NaN\n",
      "Name: yield, dtype: float64\n",
      "BEGIN add_calc_date\n",
      "yield: nan\n"
     ]
    },
    {
     "ename": "AttributeError",
     "evalue": "'str' object has no attribute 'year'",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mAttributeError\u001b[0m                            Traceback (most recent call last)",
      "Cell \u001b[0;32mIn[31], line 2\u001b[0m\n\u001b[1;32m      1\u001b[0m data \u001b[39m=\u001b[39m typecast_yield(data)\n\u001b[0;32m----> 2\u001b[0m data \u001b[39m=\u001b[39m add_calc_date(data)\n",
      "File \u001b[0;32m~/ficc/ficc/cloud_functions/fast_trade_history_redis_update/main.py:153\u001b[0m, in \u001b[0;36mfunction_timer.<locals>.wrapper\u001b[0;34m(*args, **kwargs)\u001b[0m\n\u001b[1;32m    151\u001b[0m \u001b[39mprint\u001b[39m(\u001b[39mf\u001b[39m\u001b[39m'\u001b[39m\u001b[39mBEGIN \u001b[39m\u001b[39m{\u001b[39;00mfunction_to_time\u001b[39m.\u001b[39m\u001b[39m__name__\u001b[39m\u001b[39m}\u001b[39;00m\u001b[39m'\u001b[39m)\n\u001b[1;32m    152\u001b[0m start_time \u001b[39m=\u001b[39m time\u001b[39m.\u001b[39mtime()\n\u001b[0;32m--> 153\u001b[0m result \u001b[39m=\u001b[39m function_to_time(\u001b[39m*\u001b[39;49margs, \u001b[39m*\u001b[39;49m\u001b[39m*\u001b[39;49mkwargs)\n\u001b[1;32m    154\u001b[0m end_time \u001b[39m=\u001b[39m time\u001b[39m.\u001b[39mtime()\n\u001b[1;32m    155\u001b[0m \u001b[39mprint\u001b[39m(\u001b[39mf\u001b[39m\u001b[39m'\u001b[39m\u001b[39mEND \u001b[39m\u001b[39m{\u001b[39;00mfunction_to_time\u001b[39m.\u001b[39m\u001b[39m__name__\u001b[39m\u001b[39m}\u001b[39;00m\u001b[39m. Execution time: \u001b[39m\u001b[39m{\u001b[39;00mtimedelta(seconds\u001b[39m=\u001b[39mend_time \u001b[39m-\u001b[39m start_time)\u001b[39m}\u001b[39;00m\u001b[39m'\u001b[39m)\n",
      "File \u001b[0;32m~/ficc/ficc/cloud_functions/fast_trade_history_redis_update/main.py:1209\u001b[0m, in \u001b[0;36madd_calc_date\u001b[0;34m(df)\u001b[0m\n\u001b[1;32m   1206\u001b[0m \u001b[39m@function_timer\u001b[39m\n\u001b[1;32m   1207\u001b[0m \u001b[39mdef\u001b[39;00m \u001b[39madd_calc_date\u001b[39m(df):\n\u001b[1;32m   1208\u001b[0m     \u001b[39m'''Add the calc date field for each row to the dataframe `df`.'''\u001b[39;00m\n\u001b[0;32m-> 1209\u001b[0m     df[\u001b[39m'\u001b[39m\u001b[39mcalc_price\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mcalc_date\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mprice_to_next_call\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mprice_to_par_call\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mprice_to_maturity\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mcalc_day_cat\u001b[39m\u001b[39m'\u001b[39m] \u001b[39m=\u001b[39m \u001b[39mzip\u001b[39m(\u001b[39m*\u001b[39mdf\u001b[39m.\u001b[39;49mapply(\u001b[39mlambda\u001b[39;49;00m row: compute_price(row), axis\u001b[39m=\u001b[39;49m\u001b[39m1\u001b[39;49m))    \u001b[39m# TODO: consider parallelizing, since this procedure is the main bottleneck\u001b[39;00m\n\u001b[1;32m   1210\u001b[0m     df[\u001b[39m'\u001b[39m\u001b[39mprice_delta\u001b[39m\u001b[39m'\u001b[39m] \u001b[39m=\u001b[39m np\u001b[39m.\u001b[39mround(\u001b[39mabs\u001b[39m(df\u001b[39m.\u001b[39mcalc_price \u001b[39m-\u001b[39m df\u001b[39m.\u001b[39mdollar_price), LOGGING_PRECISION)    \u001b[39m# need to be rounded to LOGGING_PRECISION (can perhaps do more but not too many more digits) decimal places otherwise will be detected as an invalid numerical value\u001b[39;00m\n\u001b[1;32m   1211\u001b[0m     \u001b[39mreturn\u001b[39;00m df\n",
      "File \u001b[0;32m~/miniforge3/lib/python3.10/site-packages/pandas/core/frame.py:9565\u001b[0m, in \u001b[0;36mDataFrame.apply\u001b[0;34m(self, func, axis, raw, result_type, args, **kwargs)\u001b[0m\n\u001b[1;32m   9554\u001b[0m \u001b[39mfrom\u001b[39;00m \u001b[39mpandas\u001b[39;00m\u001b[39m.\u001b[39;00m\u001b[39mcore\u001b[39;00m\u001b[39m.\u001b[39;00m\u001b[39mapply\u001b[39;00m \u001b[39mimport\u001b[39;00m frame_apply\n\u001b[1;32m   9556\u001b[0m op \u001b[39m=\u001b[39m frame_apply(\n\u001b[1;32m   9557\u001b[0m     \u001b[39mself\u001b[39m,\n\u001b[1;32m   9558\u001b[0m     func\u001b[39m=\u001b[39mfunc,\n\u001b[0;32m   (...)\u001b[0m\n\u001b[1;32m   9563\u001b[0m     kwargs\u001b[39m=\u001b[39mkwargs,\n\u001b[1;32m   9564\u001b[0m )\n\u001b[0;32m-> 9565\u001b[0m \u001b[39mreturn\u001b[39;00m op\u001b[39m.\u001b[39;49mapply()\u001b[39m.\u001b[39m__finalize__(\u001b[39mself\u001b[39m, method\u001b[39m=\u001b[39m\u001b[39m\"\u001b[39m\u001b[39mapply\u001b[39m\u001b[39m\"\u001b[39m)\n",
      "File \u001b[0;32m~/miniforge3/lib/python3.10/site-packages/pandas/core/apply.py:746\u001b[0m, in \u001b[0;36mFrameApply.apply\u001b[0;34m(self)\u001b[0m\n\u001b[1;32m    743\u001b[0m \u001b[39melif\u001b[39;00m \u001b[39mself\u001b[39m\u001b[39m.\u001b[39mraw:\n\u001b[1;32m    744\u001b[0m     \u001b[39mreturn\u001b[39;00m \u001b[39mself\u001b[39m\u001b[39m.\u001b[39mapply_raw()\n\u001b[0;32m--> 746\u001b[0m \u001b[39mreturn\u001b[39;00m \u001b[39mself\u001b[39;49m\u001b[39m.\u001b[39;49mapply_standard()\n",
      "File \u001b[0;32m~/miniforge3/lib/python3.10/site-packages/pandas/core/apply.py:873\u001b[0m, in \u001b[0;36mFrameApply.apply_standard\u001b[0;34m(self)\u001b[0m\n\u001b[1;32m    872\u001b[0m \u001b[39mdef\u001b[39;00m \u001b[39mapply_standard\u001b[39m(\u001b[39mself\u001b[39m):\n\u001b[0;32m--> 873\u001b[0m     results, res_index \u001b[39m=\u001b[39m \u001b[39mself\u001b[39;49m\u001b[39m.\u001b[39;49mapply_series_generator()\n\u001b[1;32m    875\u001b[0m     \u001b[39m# wrap results\u001b[39;00m\n\u001b[1;32m    876\u001b[0m     \u001b[39mreturn\u001b[39;00m \u001b[39mself\u001b[39m\u001b[39m.\u001b[39mwrap_results(results, res_index)\n",
      "File \u001b[0;32m~/miniforge3/lib/python3.10/site-packages/pandas/core/apply.py:889\u001b[0m, in \u001b[0;36mFrameApply.apply_series_generator\u001b[0;34m(self)\u001b[0m\n\u001b[1;32m    886\u001b[0m \u001b[39mwith\u001b[39;00m option_context(\u001b[39m\"\u001b[39m\u001b[39mmode.chained_assignment\u001b[39m\u001b[39m\"\u001b[39m, \u001b[39mNone\u001b[39;00m):\n\u001b[1;32m    887\u001b[0m     \u001b[39mfor\u001b[39;00m i, v \u001b[39min\u001b[39;00m \u001b[39menumerate\u001b[39m(series_gen):\n\u001b[1;32m    888\u001b[0m         \u001b[39m# ignore SettingWithCopy here in case the user mutates\u001b[39;00m\n\u001b[0;32m--> 889\u001b[0m         results[i] \u001b[39m=\u001b[39m \u001b[39mself\u001b[39;49m\u001b[39m.\u001b[39;49mf(v)\n\u001b[1;32m    890\u001b[0m         \u001b[39mif\u001b[39;00m \u001b[39misinstance\u001b[39m(results[i], ABCSeries):\n\u001b[1;32m    891\u001b[0m             \u001b[39m# If we have a view on v, we need to make a copy because\u001b[39;00m\n\u001b[1;32m    892\u001b[0m             \u001b[39m#  series_generator will swap out the underlying data\u001b[39;00m\n\u001b[1;32m    893\u001b[0m             results[i] \u001b[39m=\u001b[39m results[i]\u001b[39m.\u001b[39mcopy(deep\u001b[39m=\u001b[39m\u001b[39mFalse\u001b[39;00m)\n",
      "File \u001b[0;32m~/ficc/ficc/cloud_functions/fast_trade_history_redis_update/main.py:1209\u001b[0m, in \u001b[0;36madd_calc_date.<locals>.<lambda>\u001b[0;34m(row)\u001b[0m\n\u001b[1;32m   1206\u001b[0m \u001b[39m@function_timer\u001b[39m\n\u001b[1;32m   1207\u001b[0m \u001b[39mdef\u001b[39;00m \u001b[39madd_calc_date\u001b[39m(df):\n\u001b[1;32m   1208\u001b[0m     \u001b[39m'''Add the calc date field for each row to the dataframe `df`.'''\u001b[39;00m\n\u001b[0;32m-> 1209\u001b[0m     df[\u001b[39m'\u001b[39m\u001b[39mcalc_price\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mcalc_date\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mprice_to_next_call\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mprice_to_par_call\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mprice_to_maturity\u001b[39m\u001b[39m'\u001b[39m], df[\u001b[39m'\u001b[39m\u001b[39mcalc_day_cat\u001b[39m\u001b[39m'\u001b[39m] \u001b[39m=\u001b[39m \u001b[39mzip\u001b[39m(\u001b[39m*\u001b[39mdf\u001b[39m.\u001b[39mapply(\u001b[39mlambda\u001b[39;00m row: compute_price(row), axis\u001b[39m=\u001b[39m\u001b[39m1\u001b[39m))    \u001b[39m# TODO: consider parallelizing, since this procedure is the main bottleneck\u001b[39;00m\n\u001b[1;32m   1210\u001b[0m     df[\u001b[39m'\u001b[39m\u001b[39mprice_delta\u001b[39m\u001b[39m'\u001b[39m] \u001b[39m=\u001b[39m np\u001b[39m.\u001b[39mround(\u001b[39mabs\u001b[39m(df\u001b[39m.\u001b[39mcalc_price \u001b[39m-\u001b[39m df\u001b[39m.\u001b[39mdollar_price), LOGGING_PRECISION)    \u001b[39m# need to be rounded to LOGGING_PRECISION (can perhaps do more but not too many more digits) decimal places otherwise will be detected as an invalid numerical value\u001b[39;00m\n\u001b[1;32m   1211\u001b[0m     \u001b[39mreturn\u001b[39;00m df\n",
      "File \u001b[0;32m~/ficc/ficc/cloud_functions/fast_trade_history_redis_update/main.py:597\u001b[0m, in \u001b[0;36mcompute_price\u001b[0;34m(trade, yield_rate)\u001b[0m\n\u001b[1;32m    594\u001b[0m next_price, to_par_price, maturity_price \u001b[39m=\u001b[39m \u001b[39mfloat\u001b[39m(\u001b[39m'\u001b[39m\u001b[39minf\u001b[39m\u001b[39m'\u001b[39m), \u001b[39mfloat\u001b[39m(\u001b[39m'\u001b[39m\u001b[39minf\u001b[39m\u001b[39m'\u001b[39m), \u001b[39mfloat\u001b[39m(\u001b[39m'\u001b[39m\u001b[39minf\u001b[39m\u001b[39m'\u001b[39m)\n\u001b[1;32m    596\u001b[0m \u001b[39mif\u001b[39;00m \u001b[39mnot\u001b[39;00m pd\u001b[39m.\u001b[39misnull(trade\u001b[39m.\u001b[39mpar_call_date):\n\u001b[0;32m--> 597\u001b[0m     to_par_price \u001b[39m=\u001b[39m get_price_caller(trade\u001b[39m.\u001b[39;49mpar_call_date, trade\u001b[39m.\u001b[39;49mpar_call_price)\n\u001b[1;32m    598\u001b[0m \u001b[39mif\u001b[39;00m \u001b[39mnot\u001b[39;00m pd\u001b[39m.\u001b[39misnull(trade\u001b[39m.\u001b[39mnext_call_date):\n\u001b[1;32m    599\u001b[0m     next_price \u001b[39m=\u001b[39m get_price_caller(trade\u001b[39m.\u001b[39mnext_call_date, trade\u001b[39m.\u001b[39mnext_call_price)\n",
      "File \u001b[0;32m~/ficc/ficc/cloud_functions/fast_trade_history_redis_update/main.py:565\u001b[0m, in \u001b[0;36mcompute_price.<locals>.<lambda>\u001b[0;34m(end_date, redemption_value)\u001b[0m\n\u001b[1;32m    562\u001b[0m time_delta \u001b[39m=\u001b[39m get_time_delta_from_interest_frequency(frequency)\n\u001b[1;32m    563\u001b[0m my_prev_coupon_date, my_next_coupon_date \u001b[39m=\u001b[39m get_prev_coupon_date_and_next_coupon_date(trade, frequency, time_delta)\n\u001b[0;32m--> 565\u001b[0m get_price_caller \u001b[39m=\u001b[39m \u001b[39mlambda\u001b[39;00m end_date, redemption_value: get_price(trade\u001b[39m.\u001b[39;49mcusip, \n\u001b[1;32m    566\u001b[0m                                                                 my_prev_coupon_date, \n\u001b[1;32m    567\u001b[0m                                                                 trade\u001b[39m.\u001b[39;49mfirst_coupon_date, \n\u001b[1;32m    568\u001b[0m                                                                 my_next_coupon_date, \n\u001b[1;32m    569\u001b[0m                                                                 end_date, \n\u001b[1;32m    570\u001b[0m                                                                 trade\u001b[39m.\u001b[39;49msettlement_date, \n\u001b[1;32m    571\u001b[0m                                                                 trade\u001b[39m.\u001b[39;49maccrual_date, \n\u001b[1;32m    572\u001b[0m                                                                 frequency, \n\u001b[1;32m    573\u001b[0m                                                                 yield_rate, \n\u001b[1;32m    574\u001b[0m                                                                 trade\u001b[39m.\u001b[39;49mcoupon, \n\u001b[1;32m    575\u001b[0m                                                                 redemption_value, \n\u001b[1;32m    576\u001b[0m                                                                 time_delta, \n\u001b[1;32m    577\u001b[0m                                                                 trade\u001b[39m.\u001b[39;49mlast_period_accrues_from_date)\n\u001b[1;32m    579\u001b[0m redemption_value_at_maturity \u001b[39m=\u001b[39m \u001b[39m100\u001b[39m\n\u001b[1;32m    580\u001b[0m \u001b[39mif\u001b[39;00m (\u001b[39mnot\u001b[39;00m trade\u001b[39m.\u001b[39mis_called) \u001b[39mand\u001b[39;00m (\u001b[39mnot\u001b[39;00m trade\u001b[39m.\u001b[39mis_callable):\n",
      "File \u001b[0;32m~/ficc/ficc/cloud_functions/fast_trade_history_redis_update/main.py:511\u001b[0m, in \u001b[0;36mget_price\u001b[0;34m(cusip, prev_coupon_date, first_coupon_date, next_coupon_date, end_date, settlement_date, accrual_date, frequency, yield_rate, coupon, RV, time_delta, last_period_accrues_from_date)\u001b[0m\n\u001b[1;32m    507\u001b[0m \u001b[39melse\u001b[39;00m:\n\u001b[1;32m    508\u001b[0m     num_of_interest_payments, final_coupon_date \u001b[39m=\u001b[39m get_num_of_interest_payments_and_final_coupon_date(next_coupon_date, \n\u001b[1;32m    509\u001b[0m                                                                                                      end_date, \n\u001b[1;32m    510\u001b[0m                                                                                                      time_delta)\n\u001b[0;32m--> 511\u001b[0m     prev_coupon_date_to_settlement_date \u001b[39m=\u001b[39m diff_in_days_two_dates(settlement_date, prev_coupon_date)\n\u001b[1;32m    513\u001b[0m     num_of_days_in_period \u001b[39m=\u001b[39m NUM_OF_DAYS_IN_YEAR \u001b[39m/\u001b[39m frequency    \u001b[39m# number of days in interest payment period \u001b[39;00m\n\u001b[1;32m    514\u001b[0m     \u001b[39massert\u001b[39;00m num_of_days_in_period \u001b[39m==\u001b[39m \u001b[39mround\u001b[39m(num_of_days_in_period)\n",
      "File \u001b[0;32m~/ficc/ficc/cloud_functions/fast_trade_history_redis_update/main.py:209\u001b[0m, in \u001b[0;36mdiff_in_days_two_dates\u001b[0;34m(end_date, start_date, convention)\u001b[0m\n\u001b[1;32m    207\u001b[0m     \u001b[39mprint\u001b[39m(\u001b[39m'\u001b[39m\u001b[39munknown convention\u001b[39m\u001b[39m'\u001b[39m, convention)\n\u001b[1;32m    208\u001b[0m     \u001b[39mreturn\u001b[39;00m \u001b[39mNone\u001b[39;00m\n\u001b[0;32m--> 209\u001b[0m \u001b[39mreturn\u001b[39;00m ACCEPTED_CONVENTIONS[convention](end_date, start_date)\n",
      "File \u001b[0;32m~/ficc/ficc/cloud_functions/fast_trade_history_redis_update/main.py:184\u001b[0m, in \u001b[0;36m_diff_in_days_two_dates_360_30\u001b[0;34m(end_date, start_date)\u001b[0m\n\u001b[1;32m    181\u001b[0m \u001b[39m'''This function calculates the difference in days using the 360/30 \u001b[39;00m\n\u001b[1;32m    182\u001b[0m \u001b[39mconvention specified in MSRB Rule Book G-33, rule (e).'''\u001b[39;00m\n\u001b[1;32m    183\u001b[0m Y2 \u001b[39m=\u001b[39m end_date\u001b[39m.\u001b[39myear\n\u001b[0;32m--> 184\u001b[0m Y1 \u001b[39m=\u001b[39m start_date\u001b[39m.\u001b[39;49myear\n\u001b[1;32m    185\u001b[0m M2 \u001b[39m=\u001b[39m end_date\u001b[39m.\u001b[39mmonth\n\u001b[1;32m    186\u001b[0m M1 \u001b[39m=\u001b[39m start_date\u001b[39m.\u001b[39mmonth\n",
      "\u001b[0;31mAttributeError\u001b[0m: 'str' object has no attribute 'year'"
     ]
    }
   ],
   "source": [
    "data = typecast_yield(data)\n",
    "data = add_calc_date(data)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "base",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.8"
  },
  "orig_nbformat": 4
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
