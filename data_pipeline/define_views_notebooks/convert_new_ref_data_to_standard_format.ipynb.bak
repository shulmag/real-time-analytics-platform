{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "7477bc43",
   "metadata": {},
   "source": [
    "## Convert New Reference Data to Standard Format\n",
    "\n",
    "Written by Jesse Watson 2024-07-09 \n",
    "\n",
    "Last Updated 2025-01-09 by Jesse. \n",
    "\n",
    "Comparing these, specifically CAT, NON_CAT, BINARY, and the same for DP: https://github.com/Ficc-ai/ficc_python/blob/main/ficc/utils/auxiliary_variables.py\n",
    "\n",
    "In addition we need features for converting Y-DP, here: \n",
    "https://github.com/Ficc-ai/ficc_python/blob/main/pricing_example.ipynb\n",
    "\n",
    "The master list is derived from:  https://console.cloud.google.com/functions/details/us-central1/update-new-pipeline-ice-data?env=gen2&project=eng-reactor-287421\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ae33be4a",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "from google.cloud import bigquery\n",
    "import pandas as pd\n",
    "\n",
    "\n",
    "os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = '/Users/user/base/ficc/creds.json'\n",
    "bq_client = bigquery.Client()\n",
    "\n",
    "project = 'eng-reactor-287421'\n",
    "dataset = 'reference_data_v2'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e500baa9",
   "metadata": {},
   "outputs": [],
   "source": [
    "def mkview (name, sql):\n",
    "    db = f'{project}.{dataset}.'\n",
    "    name = db + name\n",
    "    bq_client.delete_table(name, not_found_ok=True) \n",
    "    view = bigquery.Table(name)\n",
    "    view.view_query = sql\n",
    "    view = bq_client.create_table(view)\n",
    "    return name"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ef48ab3a",
   "metadata": {},
   "outputs": [],
   "source": [
    "def sqltodf(sql, limit=''):\n",
    "    if limit != '': \n",
    "        limit = f' ORDER BY RAND() LIMIT {limit}'\n",
    "    bqr = bq_client.query(sql + limit).result()\n",
    "    return bqr.to_dataframe()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7ca2351b",
   "metadata": {},
   "source": [
    "NOTE FOR PURPOSE_CLASS, SUB_CLASS AND USE OF PROCEEDS: I used Gil’s logic (query below) to calculate the equivalence of OLD to NEW categories for use_of_proceeds.  And then I did purpose_class and purpose_sub_class, as as far as I have been able to discover there is no epistemological distinction between OLD’s “use_of_proceeds” and “purpose_class” and “purpose_sub_class”.  They all basically mean “what the money will be used for”.  I also can’t find anything besides useOfProceeds in the NEW data.  So I have mapped all three OLD fields to useOfProceeds.  OLD has more categories, but that is probably not important for training."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3fbfd222",
   "metadata": {},
   "outputs": [],
   "source": [
    "query_for_maping_ice_to_sp = f'''WITH sp_data AS (\n",
    "  SELECT\n",
    "    useOfProceeds,\n",
    "    cusip\n",
    "  FROM\n",
    "    `sp_reference_data.sp_nested`\n",
    "),\n",
    "ice_data AS (\n",
    "  SELECT\n",
    "    cusip,\n",
    "   use_of_proceeds\n",
    "  FROM\n",
    "    `eng-reactor-287421.reference_data.ice_flat`\n",
    "),\n",
    "joined_data AS (\n",
    "  SELECT\n",
    "    sd.useofproceeds AS sp_useofproceeds,\n",
    "    i.use_of_proceeds AS ice_use_of_proceeds,\n",
    "    COUNT(DISTINCT i.cusip) AS frequency\n",
    "  FROM\n",
    "    sp_data sd\n",
    "  LEFT JOIN\n",
    "    ice_data i\n",
    "  ON\n",
    "    sd.cusip = i.cusip\n",
    "  GROUP BY\n",
    "    sd.useofproceeds, i.use_of_proceeds\n",
    "),\n",
    "ranked_data AS (\n",
    "  SELECT\n",
    "    sp_useofproceeds,\n",
    "    ice_use_of_proceeds,\n",
    "    frequency,\n",
    "    ROW_NUMBER() OVER (PARTITION BY sp_useofproceeds ORDER BY frequency DESC, ice_use_of_proceeds) AS rank\n",
    "  FROM\n",
    "    joined_data\n",
    ")\n",
    "SELECT\n",
    "  sp_useofproceeds,\n",
    "  ice_use_of_proceeds,\n",
    "  frequency\n",
    "FROM\n",
    "  ranked_data\n",
    "WHERE\n",
    "  rank = 1\n",
    "ORDER BY\n",
    "  sp_useofproceeds;'''"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "48cd8508",
   "metadata": {},
   "outputs": [],
   "source": [
    "sp_nested = \"(SELECT TIMESTAMP(file_received_from_sp_date) AS file_received_from_sp_timestamp, * FROM `sp_reference_data.sp_nested`)\""
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d7b7d0e7",
   "metadata": {},
   "source": [
    "Create a `valid_from_date` and `valid_to_date` using the logic from a previous reference data table."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "664750a4",
   "metadata": {},
   "outputs": [],
   "source": [
    "valid_time = mkview (\"valid_time\", \n",
    "f'''  \n",
    "SELECT\n",
    "CASE\n",
    "    WHEN ROW_NUMBER() OVER (PARTITION BY cusip ORDER BY file_received_from_sp_timestamp ASC) = 1 THEN TIMESTAMP(\"2010-01-01 00:00:00\")\n",
    "    ELSE file_received_from_sp_timestamp\n",
    "END\n",
    "  AS ref_valid_from_date,\n",
    "  CASE\n",
    "    WHEN ROW_NUMBER() OVER (PARTITION BY cusip ORDER BY file_received_from_sp_timestamp DESC) = 1 THEN TIMESTAMP(\"2100-01-01 00:00:00\")\n",
    "    ELSE TIMESTAMP_SUB(LEAD(file_received_from_sp_timestamp) OVER (PARTITION BY cusip ORDER BY file_received_from_sp_timestamp ASC), INTERVAL 1 SECOND )\n",
    "END\n",
    "  AS ref_valid_to_date,\n",
    "  CONCAT(cusip, CAST(file_received_from_sp_date AS STRING)) AS KEY,\n",
    "  *\n",
    "FROM \n",
    "    {sp_nested}\n",
    "''')\n",
    "print(valid_time)\n",
    "%time df = sqltodf(f\"SELECT * FROM {valid_time}\", 3)\n",
    "df"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cf8646d0",
   "metadata": {},
   "source": [
    "Create new reference data flat BigQuery table."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "34fb2230",
   "metadata": {
    "scrolled": true
   },
   "outputs": [],
   "source": [
    "reference_data_flat = mkview(\"reference_data_flat\", f\"\"\"SELECT\n",
    "file_received_from_sp_timestamp as file_received_from_provider_timestamp,\n",
    "upload_datetime,\n",
    "ref_valid_from_date, ref_valid_to_date, \n",
    "  cast(currentCoupon as FLOAT64) AS coupon,\n",
    "  cusip,\n",
    "  file_received_from_sp_date,\n",
    "  stateCode AS incorporated_state_code,\n",
    "  issuerLongName AS organization_primary_name,\n",
    "  issueDescription AS instrument_primary_name,\n",
    "  --The information is mostly the same but not identical\n",
    "  dealUniqueId AS issue_key,\n",
    "  -- This will be slightly different from ICE, but looks equally correct to me.  This is crucial for the definition of similar trades.\n",
    "  issueDescription AS issue_text,\n",
    "  (\n",
    "  SELECT\n",
    "    entityName\n",
    "  FROM\n",
    "    UNNEST(entityDetails)\n",
    "  WHERE\n",
    "    entityType = 'obligor') AS conduit_obligor_name,\n",
    "  --TODO: UNNEST THIS PROPERLY, CURRENTLY NOT USED \n",
    "  CASE\n",
    "    WHEN isCallable AND callExecutionDate IS NOT NULL THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  AS is_called_alternate_definition,\n",
    "  -- A technical difference with ICE is that ETM is handled as is_called TODO: THIS IS INCORRECT BECAUSE WE WILL CONTINUE TO USE NEXTCALLDATE. MUST MAKE EQUIVALENT TO ICE. \n",
    "  CASE\n",
    "    WHEN statusSubTYpe = \"To Be Called\"  THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  AS is_called,\n",
    "  CASE\n",
    "    WHEN isCallable AND callExecutionDate IS NULL THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  AS is_callable,\n",
    "  CASE\n",
    "    WHEN statusSubTYpe = \"Escrowed to Maturity\" OR isPreRefunded THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  AS is_escrowed_or_pre_refunded,\n",
    "  firstCallablePaymentDate AS first_call_date,\n",
    "  cast(callschedule[SAFE_OFFSET(0)].minNoticeDays as INTEGER) AS call_date_notice,\n",
    "  cavFlag AS callable_at_cav,\n",
    "  cast(nextParCallPrice as Float64) AS par_price,\n",
    "  muniCallDefeasedFlag AS call_defeased,\n",
    "   null as  call_timing,--NOT NEEDED\n",
    "  null as   call_timing_in_part,--NOT NEEDED\n",
    "  hasExtraordinaryCall AS extraordinary_make_whole_call,\n",
    "  hasExtraordinaryCall AS extraordinary_redemption,\n",
    "  CASE\n",
    "    WHEN callschedule[SAFE_OFFSET(0)].makewholebenchmark IS NOT NULL THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  AS make_whole_call,\n",
    "  nextCallDate AS next_call_date,\n",
    "  cast(nextCallPrice as FLOAT64) AS next_call_price,\n",
    "  null as   call_redemption_id, --NOT NEEDED\n",
    "  nextParCallDate AS par_call_date,\n",
    "  CAST(nextParCallPrice AS FLOAT64) AS par_call_price, \n",
    "\n",
    "  CASE\n",
    "    WHEN isPreRefunded IS TRUE THEN 13\n",
    "    WHEN statusSubTYpe = \"To Be Called\" THEN 3\n",
    "    WHEN statusSubTYpe = \"Escrowed to Maturity\" THEN 5\n",
    "    ELSE NULL\n",
    "END\n",
    "  called_redemption_type,\n",
    "  null as  muni_issue_type,--NOT USED (issueType is very different, green bond is isGreenBond, but others need investigation)\n",
    "  callExecutionDate AS refund_date,\n",
    "    CASE\n",
    "    WHEN statusSubTYpe = \"To Be Called\" and \n",
    "  cast(finalCallPrice as FLOAT64) is null then 100 else cast(finalCallPrice as FLOAT64) END refund_price,\n",
    "  cavFlag AS redemption_cav_flag,\n",
    "  cast(CallSchedule[SAFE_OFFSET(0)].maxNoticeDays as integer) AS max_notification_days,\n",
    "  cast(CallSchedule[SAFE_OFFSET(0)].minNoticeDays as integer) AS min_notification_days,\n",
    "  nextPutDate AS next_put_date,\n",
    "  putschedule[SAFE_OFFSET(0)].endDate AS put_end_date,\n",
    "  cast(putschedule[SAFE_OFFSET(0)].price as FLOAT64) AS put_feature_price,\n",
    "  putschedule[SAFE_OFFSET(0)].frequency AS put_frequency,\n",
    "  putschedule[SAFE_OFFSET(0)].startDate AS put_start_date,\n",
    "  putschedule[SAFE_OFFSET(0)].methodType AS put_type, --THIS IS A DIFFERENT DATA TYPE THAN ICE\n",
    "  maturityDate AS maturity_date,\n",
    "  CASE \n",
    "    WHEN instrumentRatings[SAFE_OFFSET(0)].rating IN ('AAA', 'AA+', 'AA', 'AA-', 'A+', 'A', 'A-', 'BBB+', 'BBB', 'BBB-', 'BB+', 'BB', 'BB-', 'B+', 'B', 'B-', 'CCC+', 'CCC', 'CCC-', 'CC', 'C', 'D') \n",
    "    THEN instrumentRatings[SAFE_OFFSET(0)].rating\n",
    "    ELSE NULL\n",
    "  END AS sp_long,\n",
    "  hasSink AS has_sink_schedule,\n",
    "  nextSinkDate AS next_sink_date,\n",
    "  hasSink AS sink_indicator,\n",
    "  null as sink_amount_type_text,--BELOW NOT USED TO DEFAULT INDICATOR\n",
    "   null as sink_amount_type_type,\n",
    "  null as sink_frequency,\n",
    "  null as sink_defeased,\n",
    "   null as  additional_next_sink_date,\n",
    "   null as  sink_amount_type,\n",
    "  null as  additional_sink_frequency,\n",
    "abs(CASE \n",
    "    WHEN ARRAY_REVERSE(amountDetails)[SAFE_OFFSET(0)] IS NOT NULL THEN \n",
    "        ARRAY_REVERSE(amountDetails)[SAFE_OFFSET(0)].amountOutstanding\n",
    "    ELSE \n",
    "        currentAmountOutstanding\n",
    "END) AS min_amount_outstanding,  --we take the absolute value because we saw cases where sp had a negative values, which we think are a mistake\n",
    "abs(CASE \n",
    "    WHEN amountDetails[SAFE_OFFSET(0)].amountOutstanding IS NOT NULL THEN \n",
    "        amountDetails[SAFE_OFFSET(0)].amountOutstanding\n",
    "    ELSE \n",
    "        currentAmountOutstanding\n",
    "END) AS max_amount_outstanding, --we take the absolute value because we saw cases where sp had a negative values, which we think are a mistake\n",
    "  CASE\n",
    "    WHEN statusSubTYpe = \"In Default\" THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  default_exists,\n",
    "  hasCreditEnhancement AS has_unexpired_lines_of_credit,\n",
    "  null as  years_to_loc_expiration, --NOT USED\n",
    "  CASE\n",
    "    WHEN statusSubTYpe = \"Escrowed to Maturity\" OR isPreRefunded THEN TRUE\n",
    "    ELSE FALSE\n",
    "END escrow_exists,\n",
    "\n",
    "  null as  escrow_obligation_percent,--NOT USED\n",
    "  null as   escrow_obligation_agent,--NOT USED\n",
    " null as   escrow_obligation_type,--NOT USED\n",
    " null as  child_linkage_exists,--NOT USED\n",
    "  isPuttable AS put_exists,\n",
    "  isFloat AS floating_rate_exists,\n",
    "  secondarilyInsuredFlag AS bond_insurance_exists,\n",
    "  CASE\n",
    "    WHEN sourceOfRepayment = \"General Obligation\" THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  AS is_general_obligation,\n",
    "  CASE\n",
    "    WHEN isOriginalIssueDiscount = TRUE OR currentCoupon = 0 THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  AS has_zero_coupons,\n",
    "  -- todo: check if this is better done with paymentCategory\n",
    "  deliveryDate AS delivery_date,\n",
    "  cast(priceAtIssue as FLOAT64) AS issue_price,\n",
    "  settlementDate AS primary_market_settlement_date,\n",
    "  issueDate AS issue_date,\n",
    "  CASE\n",
    "    WHEN statusType = \"Active\" THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  outstanding_indicator,\n",
    "  CASE\n",
    "    WHEN taxStatus = 'Tax Exempt' AND amtFlag = TRUE THEN 1\n",
    "    WHEN taxStatus = 'Tax Exempt'\n",
    "  AND (amtFlag = FALSE\n",
    "    OR amtFlag IS NULL) THEN 2\n",
    "    WHEN taxStatus = 'Taxable' THEN 3\n",
    "    ELSE 0\n",
    "END\n",
    "  AS federal_tax_status,\n",
    "  cast(maturityAmount as FLOAT64) AS maturity_amount,\n",
    "  cast(mindenomination as FLOAT64) AS available_denom,\n",
    "  cast(denominationIncrease as FLOAT64) AS denom_increment_amount,\n",
    "  cast(minDenomination as FLOAT64) AS min_denom_amount,\n",
    "  interestAccrualDate AS accrual_date,\n",
    "  secondarilyInsuredFlag AS bond_insurance, --TODO: CONVERT TO STRING\n",
    "  CASE\n",
    "    WHEN paymentcategorysubtype = \"Floating: Fixed then Floating\" THEN 3\n",
    "    WHEN paymentcategorysubtype = \"Fixed: Zero Coupon\" THEN 4\n",
    "    WHEN paymentcategorysubtype = \"Floating: Floating\" THEN 5\n",
    "    WHEN paymentcategorysubtype = \"Floating: Fixed Margin over Index\" THEN 6\n",
    "    WHEN paymentcategorysubtype = \"Fixed: Plain Vanilla Fixed Coupon\" THEN 8\n",
    "    WHEN paymentcategorysubtype = \"Fixed: Pay only at Maturity\" THEN 17\n",
    "    WHEN paymentcategorysubtype = \"Variable: Zero Then Fixed\" THEN 20\n",
    "    WHEN paymentcategorysubtype = \"Variable: Step Up/Step Down\" THEN 26\n",
    "END\n",
    "  AS coupon_type,\n",
    "  cast(currentCoupon as FLOAT64) AS current_coupon_rate,\n",
    "  CASE\n",
    "    WHEN currentDayCountConvention = \"ACT/ACT\" THEN 1\n",
    "    WHEN currentDayCountConvention = \"ACT/360\" THEN 2\n",
    "    WHEN currentDayCountConvention = \"30/360\" THEN 3\n",
    "    WHEN currentDayCountConvention = \"ACT/365-366\" THEN 7\n",
    "    ELSE 0\n",
    "END\n",
    "  AS daycount_basis_type,\n",
    "  3 AS debt_type,\n",
    "  -- 3 indicates BOND in OLD DATA\n",
    "  CASE\n",
    "    WHEN statusSubTYpe = \"In Default\" THEN TRUE\n",
    "    ELSE FALSE\n",
    "END\n",
    "  default_indicator,\n",
    "  firstCouponDate AS first_coupon_date,\n",
    "  CASE\n",
    "    WHEN interestSchedule[SAFE_OFFSET(0)].couponFrequency = \"Semi\" THEN 1\n",
    "    WHEN interestSchedule[SAFE_OFFSET(0)].couponFrequency = \"Mnthly\" THEN 2\n",
    "    WHEN interestSchedule[SAFE_OFFSET(0)].couponFrequency = \"Annual\" THEN 3\n",
    "    WHEN interestSchedule[SAFE_OFFSET(0)].couponFrequency = \"Weekly\" THEN 4\n",
    "    WHEN interestSchedule[SAFE_OFFSET(0)].couponFrequency = \"Qrtrly\" THEN 5\n",
    "    WHEN interestSchedule[SAFE_OFFSET(0)].couponFrequency = \"At Mat\" THEN 16\n",
    "    WHEN interestSchedule[SAFE_OFFSET(0)].couponFrequency = \"Every 28 days\" THEN 20\n",
    "    WHEN interestSchedule[SAFE_OFFSET(0)].couponFrequency = \"Mandatory Purchase Date\" THEN 28\n",
    "    ELSE 0\n",
    "END\n",
    "  interest_payment_frequency,\n",
    "  cast(issueSize as FLOAT64) AS issue_amount,\n",
    "  penultimateCouponDate AS last_period_accrues_from_date,\n",
    "  --TODO: This is usually the same but not always.  Further investigation may be necessary.\n",
    "  nextPaymentDate AS next_coupon_payment_date,\n",
    "  firstCouponDate AS odd_first_coupon_date,\n",
    "  cast(issueSize as FLOAT64) AS orig_principal_amount,\n",
    "  cast(issueYield as FLOAT64) AS original_yield,\n",
    "  cast(currentAmountOutstanding as FLOAT64) AS outstanding_amount,\n",
    "  CASE\n",
    "    WHEN nextPaymentDate > firstCouponDate THEN CASE interestSchedule[SAFE_OFFSET(0)].couponFrequency\n",
    "    WHEN 'Every 28 days' THEN DATE_SUB(nextPaymentDate, INTERVAL 28 DAY)\n",
    "    WHEN 'Annual' THEN DATE_SUB(nextPaymentDate, INTERVAL 1 YEAR)\n",
    "    WHEN 'Mnthly' THEN DATE_SUB(nextPaymentDate, INTERVAL 1 MONTH)\n",
    "    WHEN 'Semi' THEN DATE_SUB(nextPaymentDate, INTERVAL 6 MONTH)\n",
    "    WHEN 'Weekly' THEN DATE_SUB(nextPaymentDate, INTERVAL 7 DAY)\n",
    "    WHEN 'Qrtrly' THEN DATE_SUB(nextPaymentDate, INTERVAL 3 MONTH)\n",
    "    ELSE NULL\n",
    "END\n",
    "    ELSE NULL\n",
    "END\n",
    "  AS previous_coupon_payment_date,\n",
    "     CASE \n",
    "        WHEN offeringtype = 'Competitive' THEN 1\n",
    "        WHEN offeringtype = 'Private placement' THEN 4\n",
    "        WHEN offeringtype = 'Negotiated' THEN 2\n",
    "        WHEN offeringtype = 'Limited' THEN 3\n",
    "        WHEN offeringtype = 'Remarketing' THEN 5\n",
    "        ELSE 0 -- unknown\n",
    "    END AS  sale_type,\n",
    " null as   settlement_type,--NOT USED\n",
    "  null as   additional_project_txt,--NOT USED\n",
    "  null as   asset_claim_code,--NOT USED\n",
    "  null as   additional_state_code,--NOT USED\n",
    "  null as   backed_underlying_security_id,--NOT USED\n",
    "  null as   bank_qualified,--NOT USED\n",
    "  CASE\n",
    "    WHEN capitalPurpose = 'Advanced Refunding & New Issue' THEN 3\n",
    "    WHEN capitalPurpose = 'Current/Advanced Refunding & New Issue' THEN 3\n",
    "    WHEN capitalPurpose = 'Advanced Refunding' THEN 2\n",
    "    WHEN capitalPurpose = 'New Issue' THEN 6\n",
    "    WHEN capitalPurpose = 'Current Refunding & New Issue' THEN 5\n",
    "    WHEN capitalPurpose = 'Refunding & New Issue' THEN 5\n",
    "    WHEN capitalPurpose = 'Remarketing' THEN 8\n",
    "    WHEN capitalPurpose = 'Remarketed' THEN 9\n",
    "    WHEN capitalPurpose = 'Forward' THEN 11\n",
    "    WHEN capitalPurpose = 'Current Refunding' THEN 4\n",
    "    WHEN capitalPurpose = 'Refunding' THEN 1\n",
    "    WHEN capitalPurpose = 'Current & Advanced Refunding' THEN 2\n",
    "    ELSE 99\n",
    "END\n",
    "  AS capital_type,\n",
    " null as  conditional_call_date,--NOT USED\n",
    "  null as  conditional_call_price,--NOT USED\n",
    "  null as  designated_termination_date,--NOT USED\n",
    "  null as  DTCC_status,--NOT USED\n",
    "  null as  first_execution_date,--NOT USED\n",
    "  null as  formal_award_date,--NOT USED\n",
    "  CASE\n",
    "    WHEN securityCode = 'Special Taxes' THEN 1\n",
    "    WHEN securityCode = 'Parking Revenue' THEN 8\n",
    "    WHEN securityCode = 'Limited/Unlimited Tax General Obligation' THEN 7\n",
    "    WHEN securityCode = 'Water & Sewer/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Revenue/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'State Appropriation/Unlimited Tax General Obligation' THEN 12\n",
    "    WHEN securityCode = 'Tax Increment Revenue/Limited Tax General Obligation' THEN 10\n",
    "    WHEN securityCode = 'Mortgage Loan' THEN 7\n",
    "    WHEN securityCode = 'Hospital' THEN 7\n",
    "    WHEN securityCode = 'Fuel Tax or Vehicle Tax' THEN 4\n",
    "    WHEN securityCode = 'Tax Allocation' THEN 10\n",
    "    WHEN securityCode = 'Sewer' THEN 7\n",
    "    WHEN securityCode = 'Sewer/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Special Assessment/Limited Tax General Obligation' THEN 1\n",
    "    WHEN securityCode = 'Special Assessment' THEN 1\n",
    "    WHEN securityCode = 'Nursing Home' THEN 7\n",
    "    WHEN securityCode = 'Electric/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Excise or Sales Tax' THEN 9\n",
    "    WHEN securityCode = 'Solid Waste Disposal' THEN 7\n",
    "    WHEN securityCode = 'Utility/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Excise or Sales Tax/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Utility/Limited Tax General Obligation' THEN 6\n",
    "    WHEN securityCode = 'Education Loan' THEN 7\n",
    "    WHEN securityCode = 'Revenue/Limited Tax General Obligation' THEN 8\n",
    "    WHEN securityCode = 'Revenue' THEN 8\n",
    "    WHEN securityCode = 'Tax Increment Revenue' THEN 10\n",
    "    WHEN securityCode = 'Airport Revenue/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Tuition and Other Fee' THEN 7\n",
    "    WHEN securityCode = 'Special Assessment/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Recreational Facility/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Tax Increment Revenue/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Water & Sewer' THEN 7\n",
    "    WHEN securityCode = 'Electric' THEN 7\n",
    "    WHEN securityCode = 'Transportation/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Trust Estate Pledged/Limited Tax General Obligation' THEN 6\n",
    "    WHEN securityCode = 'Tobacco Settlement' THEN 13\n",
    "    WHEN securityCode = 'Water & Sewer/Limited Tax General Obligation' THEN 6\n",
    "    WHEN securityCode = 'Lease or Rental/Unlimited Tax General Obligation' THEN 3\n",
    "    WHEN securityCode = 'Toll' THEN 7\n",
    "    WHEN securityCode = 'Turnpike' THEN 7\n",
    "    WHEN securityCode = 'Water/Limited Tax General Obligation' THEN 6\n",
    "    WHEN securityCode = 'Sales Agreement' THEN 7\n",
    "    WHEN securityCode = 'Lease or Rental' THEN 3\n",
    "    WHEN securityCode = 'Transportation' THEN 7\n",
    "    WHEN securityCode = 'Solid Waste Disposal/Limited Tax General Obligation' THEN 6\n",
    "    WHEN securityCode = '\"Taxes, Grants & State Aid\"' THEN 7\n",
    "    WHEN securityCode = 'Limited Tax General Obligation' THEN 6\n",
    "    WHEN securityCode = 'Trust Estate Pledged' THEN 7\n",
    "    WHEN securityCode = 'Electric/Limited Tax General Obligation' THEN 6\n",
    "    WHEN securityCode = 'Water/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Utility' THEN 7\n",
    "    WHEN securityCode = 'Loan Agreement' THEN 7\n",
    "    WHEN securityCode = 'Water' THEN 7\n",
    "    WHEN securityCode = 'Special Taxes/Unlimited Tax General Obligation' THEN 5\n",
    "    WHEN securityCode = 'Service Agreement' THEN 7\n",
    "    WHEN securityCode = 'Double Barreled' THEN 2\n",
    "    WHEN securityCode = 'Port Revenue' THEN 8\n",
    "    WHEN securityCode = 'Airport Revenue' THEN 8\n",
    "    WHEN securityCode = 'State Appropriation' THEN 12\n",
    "    WHEN securityCode = 'Parking Revenue/Limited Tax General Obligation' THEN 6\n",
    "    ELSE 0\n",
    "END\n",
    "  AS muni_security_type,\n",
    "  CASE\n",
    "    WHEN issueType = 'Note' AND issueSubType = 'Bond Anticipation Notes' THEN 3\n",
    "    WHEN issueType = 'Bond'\n",
    "  AND issueSubType = 'Qualified Zone Academy Bond' THEN 2\n",
    "    WHEN issueType = 'Bond' AND issueSubType = 'Qualified Energy Conservation Bond' THEN 2\n",
    "    WHEN issueType = 'Bond'\n",
    "  AND issueSubType = 'Bond' THEN 2\n",
    "    WHEN issueType = 'Certificate' AND issueSubType = 'Certificate of Obligation' THEN 6\n",
    "    WHEN issueType = 'Bond'\n",
    "  AND issueSubType = 'Build America Bond' THEN 2\n",
    "    WHEN issueType = 'Bond' AND issueSubType = 'Qualified School Construction Bond' THEN 2\n",
    "    WHEN issueType = 'Bond'\n",
    "  AND issueSubType = 'Tax Credit' THEN 2\n",
    "    WHEN issueType = 'Certificate' AND issueSubType = 'Certificate' THEN 4\n",
    "    WHEN issueType = 'Derivative'\n",
    "  AND issueSubType = 'Tender Option Bond' THEN 0 -- Unknown, as no specific code is given\n",
    "    WHEN issueType = 'Bond' AND issueSubType = 'Recovery Zone Economic Bond' THEN 2\n",
    "    WHEN issueType = 'Note'\n",
    "  AND issueSubType = 'Revenue Anticipation Notes' THEN 21\n",
    "    WHEN issueType = 'Note' AND issueSubType = 'Note Anticipation Notes' THEN 19\n",
    "    WHEN issueType = 'Certificate'\n",
    "  AND issueSubType = 'Build America Bond' THEN 2\n",
    "    WHEN issueType = 'Certificate' AND issueSubType = 'Certificate of Participation' THEN 5\n",
    "    WHEN issueType = 'STRIP'\n",
    "  AND issueSubType = 'Principal Strip' THEN 0 -- Unknown, as no specific code is given\n",
    "    WHEN issueType = 'Note' AND issueSubType = 'Promissory Notes' THEN 18\n",
    "    WHEN issueType = 'Bond'\n",
    "  AND issueSubType = 'Revenue Anticipation Notes' THEN 21\n",
    "    WHEN issueType = 'Warrant' AND issueSubType = 'Warrant' THEN 24\n",
    "    WHEN issueType = 'Note'\n",
    "  AND issueSubType = 'Note' THEN 19\n",
    "    WHEN issueType = 'Note' AND issueSubType = 'Loan Notes' THEN 14\n",
    "    WHEN issueType = 'Bond'\n",
    "  AND issueSubType = 'Tax Anticipation Notes' THEN 22\n",
    "    WHEN issueType = 'Bond' THEN 2\n",
    "    ELSE 0\n",
    "END\n",
    "  AS maturity_description_code,\n",
    "  null as  mtg_insurance, -- NOT USED\n",
    "  null as  orig_cusip_status,--NOT USED\n",
    "  null as  orig_instrument_enhancement_type,--NOT USED\n",
    "  null as  other_enhancement_type,--NOT USED\n",
    "  null as  other_enhancement_company,--NOT USED\n",
    "  null as  pac_bond_indicator,-- TODO FIX THIS AND MAKE BOOLEAN> \n",
    "  null as  project_name,--NOT USED\n",
    "CASE \n",
    "    WHEN useOfProceeds = \"Agriculture\" THEN 50\n",
    "    WHEN useOfProceeds = \"Airlines\" THEN 20\n",
    "    WHEN useOfProceeds = \"Airport\" THEN 48\n",
    "    WHEN useOfProceeds = \"Assisted Living\" THEN 17\n",
    "    WHEN useOfProceeds = \"Bridges\" THEN 48\n",
    "    WHEN useOfProceeds = \"Building\" THEN 51\n",
    "    WHEN useOfProceeds = \"Charter School\" THEN 9\n",
    "    WHEN useOfProceeds = \"Civic/Convention Centers\" THEN 46\n",
    "    WHEN useOfProceeds = \"Combined Utilities\" THEN 25\n",
    "    WHEN useOfProceeds = \"Correction Facilities\" THEN 3\n",
    "    WHEN useOfProceeds = \"Correction Facilities/Courts\" THEN 3\n",
    "    WHEN useOfProceeds = \"Courts\" THEN 3\n",
    "    WHEN useOfProceeds = \"Economic Development\" THEN 46\n",
    "    WHEN useOfProceeds = \"Education\" THEN 9\n",
    "    WHEN useOfProceeds = \"Electric & Public Power\" THEN 50\n",
    "    WHEN useOfProceeds = \"Electricity\" THEN 50\n",
    "    WHEN useOfProceeds = \"Environment Protection\" THEN 46\n",
    "    WHEN useOfProceeds = \"Equipment\" THEN 28\n",
    "    WHEN useOfProceeds = \"Fire Station & Equipment\" THEN 13\n",
    "    WHEN useOfProceeds = \"Flood Control/Storm Drain\" THEN 50\n",
    "    WHEN useOfProceeds = \"Gas\" THEN 20\n",
    "    WHEN useOfProceeds = \"General Purpose\" THEN 51\n",
    "    WHEN useOfProceeds = \"Government/Public Buildings\" THEN 3\n",
    "    WHEN useOfProceeds = \"Healthcare System\" THEN 17\n",
    "    WHEN useOfProceeds = \"Higher Education\" THEN 9\n",
    "    WHEN useOfProceeds = \"Highways\" THEN 48\n",
    "    WHEN useOfProceeds = \"Hospital Equipment Loans\" THEN 17\n",
    "    WHEN useOfProceeds = \"Hospitals\" THEN 17\n",
    "    WHEN useOfProceeds = \"Housing\" THEN 18\n",
    "    WHEN useOfProceeds = \"Industrial Development\" THEN 20\n",
    "    WHEN useOfProceeds = \"Land Preservation\" THEN 46\n",
    "    WHEN useOfProceeds = \"Libraries\" THEN 21\n",
    "    WHEN useOfProceeds = \"Libraries/Museums\" THEN 21\n",
    "    WHEN useOfProceeds = \"Malls/Shopping Centers\" THEN 19\n",
    "    WHEN useOfProceeds = \"Mass/Rapid Transport\" THEN 46\n",
    "    WHEN useOfProceeds = \"Multi-Family Housing\" THEN 18\n",
    "    WHEN useOfProceeds = \"Museums\" THEN 46\n",
    "    WHEN useOfProceeds = \"Nurse Homes\" THEN 17\n",
    "    WHEN useOfProceeds = \"Office Building\" THEN 3\n",
    "    WHEN useOfProceeds = \"Other Education\" THEN 9\n",
    "    WHEN useOfProceeds = \"Other Healthcare\" THEN 17\n",
    "    WHEN useOfProceeds = \"Other Housing\" THEN 18\n",
    "    WHEN useOfProceeds = \"Other Transportation\" THEN 46\n",
    "    WHEN useOfProceeds = \"Other Utilities\" THEN 50\n",
    "    WHEN useOfProceeds = \"Parking Facilities\" THEN 27\n",
    "    WHEN useOfProceeds = \"Parks\" THEN 26\n",
    "    WHEN useOfProceeds = \"Parks/Zoos/Beaches\" THEN 26\n",
    "    WHEN useOfProceeds = \"Pension Funding/Retirement\" THEN 15\n",
    "    WHEN useOfProceeds = \"Police Station/Equipment\" THEN 3\n",
    "    WHEN useOfProceeds = \"Pollution Control\" THEN 28\n",
    "    WHEN useOfProceeds = \"Primary & Secondary Education\" THEN 37\n",
    "    WHEN useOfProceeds = \"Psychiatric\" THEN 46\n",
    "    WHEN useOfProceeds = \"Public Improvements\" THEN 51\n",
    "    WHEN useOfProceeds = \"Public Power\" THEN 50\n",
    "    WHEN useOfProceeds = \"Public Safety\" THEN 3\n",
    "    WHEN useOfProceeds = \"Rail\" THEN 23\n",
    "    WHEN useOfProceeds = \"Recreation\" THEN 34\n",
    "    WHEN useOfProceeds = \"Redevelopment/Ld Clearance\" THEN 46\n",
    "    WHEN useOfProceeds = \"Rehabilitation\" THEN 17\n",
    "    WHEN useOfProceeds = \"Resource Recovery\" THEN 20\n",
    "    WHEN useOfProceeds = \"Retirement Centers\" THEN 17\n",
    "    WHEN useOfProceeds = \"Road/Highway\" THEN 48\n",
    "    WHEN useOfProceeds = \"Roads\" THEN 25\n",
    "    WHEN useOfProceeds = \"Sanitation\" THEN 38\n",
    "    WHEN useOfProceeds = \"Seaports/Marine Terminals\" THEN 48\n",
    "    WHEN useOfProceeds = \"Senior Housing\" THEN 18\n",
    "    WHEN useOfProceeds = \"Sewer\" THEN 50\n",
    "    WHEN useOfProceeds = \"Single Family Housing\" THEN 18\n",
    "    WHEN useOfProceeds = \"Single and Multi-Family Housing\" THEN 18\n",
    "    WHEN useOfProceeds = \"Solid Waste\" THEN 20\n",
    "    WHEN useOfProceeds = \"Solid Waste/Resource Recovery\" THEN 50\n",
    "    WHEN useOfProceeds = \"Stadiums/Sports Complex\" THEN 46\n",
    "    WHEN useOfProceeds = \"Student Loans\" THEN 9\n",
    "    WHEN useOfProceeds = \"Swimming Pool\" THEN 18\n",
    "    WHEN useOfProceeds = \"TeleCommunication\" THEN 11\n",
    "    WHEN useOfProceeds = \"Theaters\" THEN 8\n",
    "    WHEN useOfProceeds = \"Tobacco\" THEN 1\n",
    "    WHEN useOfProceeds = \"Toll Roads/Highways/Streets\" THEN 48\n",
    "    WHEN useOfProceeds = \"Transportation\" THEN 48\n",
    "    WHEN useOfProceeds = \"Tunnels\" THEN 48\n",
    "    WHEN useOfProceeds = \"Turnpike\" THEN 48\n",
    "    WHEN useOfProceeds = \"Various Purpose\" THEN 51\n",
    "    WHEN useOfProceeds = \"Veterans\" THEN 52\n",
    "    WHEN useOfProceeds = \"Water\" THEN 50\n",
    "    WHEN useOfProceeds = \"Water & Sewer\" THEN 50\n",
    "    ELSE 0\n",
    "END AS purpose_class,\n",
    "\n",
    "CASE \n",
    "    WHEN useOfProceeds = \"Agriculture\" THEN 117\n",
    "    WHEN useOfProceeds = \"Airlines\" THEN 5\n",
    "    WHEN useOfProceeds = \"Airport\" THEN 5\n",
    "    WHEN useOfProceeds = \"Assisted Living\" THEN 20\n",
    "    WHEN useOfProceeds = \"Bridges\" THEN 10\n",
    "    WHEN useOfProceeds = \"Building\" THEN 17\n",
    "    WHEN useOfProceeds = \"Charter School\" THEN 126\n",
    "    WHEN useOfProceeds = \"Civic/Convention Centers\" THEN 108\n",
    "    WHEN useOfProceeds = \"Combined Utilities\" THEN 35\n",
    "    WHEN useOfProceeds = \"Correction Facilities\" THEN 22\n",
    "    WHEN useOfProceeds = \"Correction Facilities/Courts\" THEN 10\n",
    "    WHEN useOfProceeds = \"Courts\" THEN 55\n",
    "    WHEN useOfProceeds = \"Economic Development\" THEN 35\n",
    "    WHEN useOfProceeds = \"Education\" THEN 122\n",
    "    WHEN useOfProceeds = \"Electric & Public Power\" THEN 28\n",
    "    WHEN useOfProceeds = \"Electricity\" THEN 28\n",
    "    WHEN useOfProceeds = \"Environment Protection\" THEN 32\n",
    "    WHEN useOfProceeds = \"Equipment\" THEN 46\n",
    "    WHEN useOfProceeds = \"Fire Station & Equipment\" THEN 51\n",
    "    WHEN useOfProceeds = \"Flood Control/Storm Drain\" THEN 40\n",
    "    WHEN useOfProceeds = \"Gas\" THEN 133\n",
    "    WHEN useOfProceeds = \"General Purpose\" THEN 73\n",
    "    WHEN useOfProceeds = \"Government/Public Buildings\" THEN 56\n",
    "    WHEN useOfProceeds = \"Healthcare System\" THEN 48\n",
    "    WHEN useOfProceeds = \"Higher Education\" THEN 87\n",
    "    WHEN useOfProceeds = \"Highways\" THEN 63\n",
    "    WHEN useOfProceeds = \"Hospital Equipment Loans\" THEN 33\n",
    "    WHEN useOfProceeds = \"Hospitals\" THEN 48\n",
    "    WHEN useOfProceeds = \"Housing\" THEN 106\n",
    "    WHEN useOfProceeds = \"Industrial Development\" THEN 124\n",
    "    WHEN useOfProceeds = \"Land Preservation\" THEN 25\n",
    "    WHEN useOfProceeds = \"Libraries\" THEN 51\n",
    "    WHEN useOfProceeds = \"Libraries/Museums\" THEN 51\n",
    "    WHEN useOfProceeds = \"Malls/Shopping Centers\" THEN 19\n",
    "    WHEN useOfProceeds = \"Mass/Rapid Transport\" THEN 32\n",
    "    WHEN useOfProceeds = \"Multi-Family Housing\" THEN 64\n",
    "    WHEN useOfProceeds = \"Museums\" THEN 33\n",
    "    WHEN useOfProceeds = \"Nurse Homes\" THEN 20\n",
    "    WHEN useOfProceeds = \"Office Building\" THEN 53\n",
    "    WHEN useOfProceeds = \"Other Education\" THEN 118\n",
    "    WHEN useOfProceeds = \"Other Healthcare\" THEN 48\n",
    "    WHEN useOfProceeds = \"Other Housing\" THEN 64\n",
    "    WHEN useOfProceeds = \"Other Transportation\" THEN 32\n",
    "    WHEN useOfProceeds = \"Other Utilities\" THEN 17\n",
    "    WHEN useOfProceeds = \"Parking Facilities\" THEN 16\n",
    "    WHEN useOfProceeds = \"Parks\" THEN 51\n",
    "    WHEN useOfProceeds = \"Parks/Zoos/Beaches\" THEN 31\n",
    "    WHEN useOfProceeds = \"Pension Funding/Retirement\" THEN 51\n",
    "    WHEN useOfProceeds = \"Police Station/Equipment\" THEN 65\n",
    "    WHEN useOfProceeds = \"Pollution Control\" THEN 78\n",
    "    WHEN useOfProceeds = \"Primary & Secondary Education\" THEN 51\n",
    "    WHEN useOfProceeds = \"Psychiatric\" THEN 108\n",
    "    WHEN useOfProceeds = \"Public Improvements\" THEN 21\n",
    "    WHEN useOfProceeds = \"Public Power\" THEN 80\n",
    "    WHEN useOfProceeds = \"Public Safety\" THEN 75\n",
    "    WHEN useOfProceeds = \"Rail\" THEN 23\n",
    "    WHEN useOfProceeds = \"Recreation\" THEN 33\n",
    "    WHEN useOfProceeds = \"Redevelopment/Ld Clearance\" THEN 79\n",
    "    WHEN useOfProceeds = \"Rehabilitation\" THEN 20\n",
    "    WHEN useOfProceeds = \"Resource Recovery\" THEN 28\n",
    "    WHEN useOfProceeds = \"Retirement Centers\" THEN 20\n",
    "    WHEN useOfProceeds = \"Road/Highway\" THEN 17\n",
    "    WHEN useOfProceeds = \"Roads\" THEN 12\n",
    "    WHEN useOfProceeds = \"Sanitation\" THEN 15\n",
    "    WHEN useOfProceeds = \"Seaports/Marine Terminals\" THEN 79\n",
    "    WHEN useOfProceeds = \"Senior Housing\" THEN 102\n",
    "    WHEN useOfProceeds = \"Sewer\" THEN 104\n",
    "    WHEN useOfProceeds = \"Single Family Housing\" THEN 106\n",
    "    WHEN useOfProceeds = \"Single and Multi-Family Housing\" THEN 106\n",
    "    WHEN useOfProceeds = \"Solid Waste\" THEN 107\n",
    "    WHEN useOfProceeds = \"Solid Waste/Resource Recovery\" THEN 107\n",
    "    WHEN useOfProceeds = \"Stadiums/Sports Complex\" THEN 33\n",
    "    WHEN useOfProceeds = \"Student Loans\" THEN 112\n",
    "    WHEN useOfProceeds = \"Swimming Pool\" THEN 64\n",
    "    WHEN useOfProceeds = \"TeleCommunication\" THEN 60\n",
    "    WHEN useOfProceeds = \"Theaters\" THEN 33\n",
    "    WHEN useOfProceeds = \"Tobacco\" THEN 118\n",
    "    WHEN useOfProceeds = \"Toll Roads/Highways/Streets\" THEN 89\n",
    "    WHEN useOfProceeds = \"Transportation\" THEN 32\n",
    "    WHEN useOfProceeds = \"Tunnels\" THEN 10\n",
    "    WHEN useOfProceeds = \"Turnpike\" THEN 121\n",
    "    WHEN useOfProceeds = \"Various Purpose\" THEN 45\n",
    "    WHEN useOfProceeds = \"Veterans\" THEN 38\n",
    "    WHEN useOfProceeds = \"Water\" THEN 125\n",
    "    WHEN useOfProceeds = \"Water & Sewer\" THEN 50\n",
    "    ELSE 0\n",
    "END AS purpose_sub_class, \n",
    "  null as   refunding_issue_key,--NOT USED\n",
    "   null as  refunding_dated_date,--NOT USED\n",
    "   null as  sale_date,--NOT USED\n",
    "  CASE\n",
    "    WHEN is144A AND NOT isPrivatePlacement AND NOT isAccreditedInvestor THEN 1\n",
    "    WHEN is144A\n",
    "  AND isPrivatePlacement\n",
    "  AND NOT isAccreditedInvestor THEN 2\n",
    "    WHEN NOT is144A AND isPrivatePlacement AND NOT isAccreditedInvestor THEN 3\n",
    "    ELSE NULL\n",
    "END\n",
    "  AS sec_regulation,\n",
    "  null as   secured, --NOT USED\n",
    "  null as   series_name, --NOT USED\n",
    "  null as   sink_fund_redemption_method, --NOT USED\n",
    "  CASE\n",
    "    WHEN isStateTaxApplicable THEN 3\n",
    "    WHEN isStateTaxApplicable IS FALSE THEN 1\n",
    "    ELSE 0\n",
    "END\n",
    "  AS state_tax_status,\n",
    "  null as   tax_credit_frequency, --NOT USED\n",
    "  null as   tax_credit_percent, --NOT USED\n",
    " CASE \n",
    "    WHEN useOfProceeds = \"Agriculture\" THEN 62\n",
    "    WHEN useOfProceeds = \"Airlines\" THEN 50\n",
    "    WHEN useOfProceeds = \"Airport\" THEN 50\n",
    "    WHEN useOfProceeds = \"Assisted Living\" THEN 31\n",
    "    WHEN useOfProceeds = \"Bridges\" THEN 53\n",
    "    WHEN useOfProceeds = \"Building\" THEN 20\n",
    "    WHEN useOfProceeds = \"Charter School\" THEN 15\n",
    "    WHEN useOfProceeds = \"Civic/Convention Centers\" THEN 45\n",
    "    WHEN useOfProceeds = \"Combined Utilities\" THEN 60\n",
    "    WHEN useOfProceeds = \"Correction Facilities\" THEN 19\n",
    "    WHEN useOfProceeds = \"Correction Facilities/Courts\" THEN 19\n",
    "    WHEN useOfProceeds = \"Courts\" THEN 19\n",
    "    WHEN useOfProceeds = \"Economic Development\" THEN 20\n",
    "    WHEN useOfProceeds = \"Education\" THEN 13\n",
    "    WHEN useOfProceeds = \"Electric & Public Power\" THEN 59\n",
    "    WHEN useOfProceeds = \"Electricity\" THEN 59\n",
    "    WHEN useOfProceeds = \"Environment Protection\" THEN 20\n",
    "    WHEN useOfProceeds = \"Equipment\" THEN 20\n",
    "    WHEN useOfProceeds = \"Fire Station & Equipment\" THEN 18\n",
    "    WHEN useOfProceeds = \"Flood Control/Storm Drain\" THEN 64\n",
    "    WHEN useOfProceeds = \"Gas\" THEN 61\n",
    "    WHEN useOfProceeds = \"General Purpose\" THEN 20\n",
    "    WHEN useOfProceeds = \"Government/Public Buildings\" THEN 17\n",
    "    WHEN useOfProceeds = \"Healthcare System\" THEN 28\n",
    "    WHEN useOfProceeds = \"Higher Education\" THEN 14\n",
    "    WHEN useOfProceeds = \"Highways\" THEN 52\n",
    "    WHEN useOfProceeds = \"Hospital Equipment Loans\" THEN 28\n",
    "    WHEN useOfProceeds = \"Hospitals\" THEN 28\n",
    "    WHEN useOfProceeds = \"Housing\" THEN 1\n",
    "    WHEN useOfProceeds = \"Industrial Development\" THEN 34\n",
    "    WHEN useOfProceeds = \"Land Preservation\" THEN 45\n",
    "    WHEN useOfProceeds = \"Libraries\" THEN 12\n",
    "    WHEN useOfProceeds = \"Libraries/Museums\" THEN 12\n",
    "    WHEN useOfProceeds = \"Malls/Shopping Centers\" THEN 0\n",
    "    WHEN useOfProceeds = \"Mass/Rapid Transport\" THEN 56\n",
    "    WHEN useOfProceeds = \"Multi-Family Housing\" THEN 2\n",
    "    WHEN useOfProceeds = \"Museums\" THEN 12\n",
    "    WHEN useOfProceeds = \"Nurse Homes\" THEN 32\n",
    "    WHEN useOfProceeds = \"Office Building\" THEN 17\n",
    "    WHEN useOfProceeds = \"Other Education\" THEN 13\n",
    "    WHEN useOfProceeds = \"Other Healthcare\" THEN 28\n",
    "    WHEN useOfProceeds = \"Other Housing\" THEN 2\n",
    "    WHEN useOfProceeds = \"Other Transportation\" THEN 56\n",
    "    WHEN useOfProceeds = \"Other Utilities\" THEN 60\n",
    "    WHEN useOfProceeds = \"Parking Facilities\" THEN 55\n",
    "    WHEN useOfProceeds = \"Parks\" THEN 48\n",
    "    WHEN useOfProceeds = \"Parks/Zoos/Beaches\" THEN 48\n",
    "    WHEN useOfProceeds = \"Pension Funding/Retirement\" THEN 74\n",
    "    WHEN useOfProceeds = \"Police Station/Equipment\" THEN 21\n",
    "    WHEN useOfProceeds = \"Pollution Control\" THEN 35\n",
    "    WHEN useOfProceeds = \"Primary & Secondary Education\" THEN 9\n",
    "    WHEN useOfProceeds = \"Psychiatric\" THEN 26\n",
    "    WHEN useOfProceeds = \"Public Improvements\" THEN 20\n",
    "    WHEN useOfProceeds = \"Public Power\" THEN 59\n",
    "    WHEN useOfProceeds = \"Public Safety\" THEN 20\n",
    "    WHEN useOfProceeds = \"Rail\" THEN 56\n",
    "    WHEN useOfProceeds = \"Recreation\" THEN 20\n",
    "    WHEN useOfProceeds = \"Redevelopment/Ld Clearance\" THEN 22\n",
    "    WHEN useOfProceeds = \"Rehabilitation\" THEN 31\n",
    "    WHEN useOfProceeds = \"Resource Recovery\" THEN 34\n",
    "    WHEN useOfProceeds = \"Retirement Centers\" THEN 31\n",
    "    WHEN useOfProceeds = \"Road/Highway\" THEN 52\n",
    "    WHEN useOfProceeds = \"Roads\" THEN 52\n",
    "    WHEN useOfProceeds = \"Sanitation\" THEN 63\n",
    "    WHEN useOfProceeds = \"Seaports/Marine Terminals\" THEN 51\n",
    "    WHEN useOfProceeds = \"Senior Housing\" THEN 6\n",
    "    WHEN useOfProceeds = \"Sewer\" THEN 68\n",
    "    WHEN useOfProceeds = \"Single Family Housing\" THEN 1\n",
    "    WHEN useOfProceeds = \"Single and Multi-Family Housing\" THEN 1\n",
    "    WHEN useOfProceeds = \"Solid Waste\" THEN 36\n",
    "    WHEN useOfProceeds = \"Solid Waste/Resource Recovery\" THEN 36\n",
    "    WHEN useOfProceeds = \"Stadiums/Sports Complex\" THEN 46\n",
    "    WHEN useOfProceeds = \"Student Loans\" THEN 11\n",
    "    WHEN useOfProceeds = \"Swimming Pool\" THEN 2\n",
    "    WHEN useOfProceeds = \"TeleCommunication\" THEN 20\n",
    "    WHEN useOfProceeds = \"Theaters\" THEN 47\n",
    "    WHEN useOfProceeds = \"Tobacco\" THEN 20\n",
    "    WHEN useOfProceeds = \"Toll Roads/Highways/Streets\" THEN 52\n",
    "    WHEN useOfProceeds = \"Transportation\" THEN 52\n",
    "    WHEN useOfProceeds = \"Tunnels\" THEN 54\n",
    "    WHEN useOfProceeds = \"Turnpike\" THEN 57\n",
    "    WHEN useOfProceeds = \"Various Purpose\" THEN 20\n",
    "    WHEN useOfProceeds = \"Veterans\" THEN 70\n",
    "    WHEN useOfProceeds = \"Water\" THEN 66\n",
    "    WHEN useOfProceeds = \"Water & Sewer\" THEN 60\n",
    "    ELSE 0\n",
    "    END AS use_of_proceeds,\n",
    "    NULL AS first_optional_redemption_code,\n",
    "    NULL AS second_optional_redemption_code,\n",
    "    NULL AS third_optional_redemption_code,\n",
    "    NULL AS first_mandatory_redemption_code,\n",
    "    NULL AS second_mandatory_redemption_code,\n",
    "    NULL AS third_mandatory_redemption_code,\n",
    "    NULL AS sp_stand_alone,\n",
    "    NULL AS sp_icr_school,\n",
    "    NULL AS sp_prelim_long,\n",
    "    NULL AS sp_outlook_long,\n",
    "    NULL AS sp_watch_long,\n",
    "    NULL AS sp_Short_Rating,\n",
    "    NULL AS sp_Credit_Watch_Short_Rating,\n",
    "    NULL AS sp_Recovery_Long_Rating,\n",
    "    NULL AS moodys_long,\n",
    "    NULL AS moodys_short,\n",
    "    NULL AS moodys_Issue_Long_Rating,\n",
    "    NULL AS moodys_Issue_Short_Rating,\n",
    "    NULL AS moodys_Credit_Watch_Long_Rating,\n",
    "    NULL AS moodys_Credit_Watch_Short_Rating,\n",
    "    NULL AS moodys_Enhanced_Long_Rating,\n",
    "    NULL AS moodys_Enhanced_Short_Rating,\n",
    "    NULL AS moodys_Credit_Watch_Long_Outlook_Rating,\n",
    "    NULL AS maximum_call_notice_period,\n",
    "    NULL AS use_of_proceeds_supplementary,\n",
    "    CONCAT(issuerlongname, issueDescription) as series_id,\n",
    "    CONCAT(IFNULL(issuerLongName, \"\"), \" \", IFNULL(issueDescription, \"\"), \" \", IFNULL(( SELECT entityName FROM UNNEST(entityDetails) WHERE entityType = 'obligor'), \"\")) AS security_description\n",
    "    FROM\n",
    "{valid_time}\n",
    "\"\"\")\n",
    "print(reference_data_flat)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "563e4930",
   "metadata": {},
   "outputs": [],
   "source": [
    "%time df = sqltodf (f\"select * from {reference_data_flat}\",3)\n",
    "df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fe2e26ce-4cba-42b1-bc6d-a997e67a1a91",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.18"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
